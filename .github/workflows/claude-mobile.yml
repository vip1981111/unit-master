name: Claude Mobile Control

# ÙŠØ¹Ù…Ù„ Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙŠ Issues Ø£Ùˆ Pull Requests
on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened]

jobs:
  claude-response:
    # ÙŠØ¹Ù…Ù„ ÙÙ‚Ø· Ø¥Ø°Ø§ Ø°ÙƒØ±Øª @claude
    if: contains(github.event.comment.body || github.event.issue.body, '@claude')
    runs-on: self-hosted  # â† ÙŠØ³ØªØ®Ø¯Ù… Mac ÙÙŠ Ø¨ÙŠØªÙƒ

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Install Dependencies
        run: |
          flutter pub get

      - name: Run Claude Code
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Flutter Tests
        if: success()
        run: |
          flutter test --reporter=expanded

      - name: Build iOS (Simulator)
        if: success()
        run: |
          flutter build ios --simulator --debug

      - name: Run iOS Simulator Test
        if: success()
        run: |
          # ØªØ´ØºÙŠÙ„ iOS Simulator
          xcrun simctl boot "iPhone 15" || true

          # ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
          xcrun simctl install booted build/ios/iphonesimulator/Runner.app

          # ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
          xcrun simctl launch booted com.example.app

          # Ø§Ù†ØªØ¸Ø§Ø± 10 Ø«ÙˆØ§Ù†ÙŠ Ø«Ù… Ø£Ø®Ø° screenshot
          sleep 10
          xcrun simctl io booted screenshot screenshot.png

      - name: Upload Screenshot
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ios-screenshot
          path: screenshot.png

      - name: Comment Result
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? 'âœ…' : 'âŒ';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${status} **Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªÙ†ÙÙŠØ°:** ${{ job.status }}\n\nğŸ“± Screenshot Ù…ØªØ§Ø­ ÙÙŠ Artifacts`
            });
